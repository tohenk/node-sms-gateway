<% menus = {
    branding: {
        type: 'brand',
        title: apptitle,
        logo: '/images/logo.png',
        url: '/'
    },
    tasks: {
        title: 'Tasks',
        class: 'right floated',
        items: {
            about: {
                title: 'About'
            },
            divider1: {
                type: 'divider'
            },
            readmsg: {
                title: 'Read messages from storage'
            },
            checkreport: {
                title: 'Check delivery report'
            }
        }
    }
} %>
<% if(user.authenticated) {
    menus.tasks.items.divider2 = {
        type: 'divider'
    }
    menus.tasks.items.logout = {
        title: 'Logout',
        url: '/logout'
    }
} %>
<% block('mainmenu', menu(menus, {mainmenu: true, indentation: 2})); %>
<% script.create('jQuery')
  .useDependencies(['jQuery/Util', 'jQuery/Notification', 'SemanticUI/Calendar', 'SemanticUI/Dialog/Message'])
  .add(`
$.tasks = {
    notifyResult: function(result) {
        if (result.success) {
            $.ntfy.notify('Operation successfully submitted!', 'success');
        } else {
            $.ntfy.notify('Operation failed!', 'error');
        }
    },
    about: function() {
        var self = this;
        var f = function() {
            var msg = $.util.template('<p>%TITLE% version %VERSION%<br/>' +
                '(c) %AUTHOR%<br/>' +
                'Licensed under %LICENSE%</p>', {
                TITLE: self.aboutInfo.title,
                VERSION: self.aboutInfo.version,
                AUTHOR: $('<div>').text(self.aboutInfo.author).html(),
                LICENSE: self.aboutInfo.license
            });
            $.ntdlg.message('task-about', 'About', msg, $.ntdlg.ICON_INFO);
        }
        if (!self.aboutInfo) {
            $.get('/about').then(function(json) {
                self.aboutInfo = json;
                f();
            });
        } else {
            f();
        }
    },
    readMessages: function() {
        var self = this;
        if (!self.readmsgdlg) {
            var message =
                '<form class="ui container form">' +
                    '<div class="field">' +
                        '<label>Select message type to read:</label>' +
                        '<select name="type" class="ui dropdown">' +
                            '<option value="0">Unread messages</option>' +
                            '<option value="1">Read messages</option>' +
                        '</select>' +
                    '</div>' +
                '</form>';
            self.readmsgdlg = $.ntdlg.dialog('readmsgdlg', 'Read Messages', message, 'envelope icon', {
                'okay': {
                    type: 'green approve',
                    caption: '<i class="check icon"></i>Ok',
                    handler: function() {
                        var t = parseInt(self.readmsgdlg.find('select[name="type"]').val());
                        $.post('/tasks/readmsg', {type: t}).then(function(json) {
                            self.notifyResult(json);
                        });
                    }
                },
                'cancel': {
                    type: 'red deny',
                    caption: '<i class="times icon"></i>Cancel'
                }
            });
            self.readmsgdlg.find('select.dropdown').dropdown();
        }
        $.ntdlg.show(self.readmsgdlg);
    },
    checkReport: function() {
        var self = this;
        if (!self.checkrptdlg) {
            var message =
                '<form class="ui container form">' +
                    '<div class="field">' +
                        '<label>Check for message report since:</label>' +
                        '<div class="ui calendar">' +
                            '<div class="ui input left icon">' +
                               '<i class="calendar icon"></i>' +
                               '<input name="since" type="text" placeholder="Date/Time">' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</form>';
            self.checkrptdlg = $.ntdlg.dialog('checkrptdlg', 'Check report', message, 'envelope icon', {
                'okay': {
                    type: 'green approve',
                    caption: '<i class="check icon"></i>Ok',
                    handler: function() {
                        var t = self.checkrptdlg.find('input[name="since"]');
                        try {
                            dt = new Date(t.val());
                        } catch (e) {
                            t.focus();
                            return false;
                        }
                        $.post('/tasks/report', {since: dt.valueOf()}).then(function(json) {
                            self.notifyResult(json);
                        });
                    }
                },
                'cancel': {
                    type: 'red deny',
                    caption: '<i class="times icon"></i>Cancel'
                }
            });
            self.checkrptdlg.find('.ui.calendar').calendar({type: 'datetime'});
        }
        $.ntdlg.show(self.checkrptdlg);
    },
    init: function() {
        var self = this;
        $('.menu-about').on('click', function(e) {
            e.preventDefault();
            self.about();
        });
        $('.menu-readmsg').on('click', function(e) {
            e.preventDefault();
            self.readMessages();
        });
        $('.menu-checkreport').on('click', function(e) {
            e.preventDefault();
            self.checkReport();
        });
    }
}
`); %>